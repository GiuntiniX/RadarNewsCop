<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Radar de Not√≠cias ‚Äî Melhorias Aplicadas</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0f1112;
      --panel:#151718;
      --muted:#9aa3a8;
      --accent:#00aced;
      --card:#ffffff;
      --card-text:#111;
      --gap:14px;
      --page-size:20;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
      background:var(--bg);
      color:#e8eef0;
      -webkit-font-smoothing:antialiased;
    }

    header{
      background:linear-gradient(180deg,#141619 0%,#111214 100%);
      border-bottom:1px solid rgba(255,255,255,0.03);
      padding:14px 16px;
      position:sticky;
      top:0;
      z-index:80;
    }
    .header-inner{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:36px;height:36px}
    .brand .title{font-weight:700;font-size:1.1rem;color:var(--accent)}
    .meta{color:var(--muted);font-size:0.88rem}
    .meta a{color:var(--accent);text-decoration:underline}

    /* Menu √∫nico apenas editorias */
    .menu-area{
      max-width:1200px;
      margin:12px auto 0;
      padding:12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
      background:linear-gradient(90deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.02);
    }
    .editoria-btn{
      padding:8px 12px;
      border-radius:10px;
      border:0;
      cursor:pointer;
      color:#fff;
      font-weight:700;
      background:linear-gradient(90deg,var(--accent),#48d6ff);
      box-shadow:0 6px 16px rgba(0,172,237,0.08);
      transition:transform .12s ease, box-shadow .12s ease, opacity .12s;
    }
    .editoria-btn[disabled]{ opacity:0.5; cursor:not-allowed; box-shadow:none }
    .editoria-btn.active{ box-shadow:0 10px 30px rgba(0,172,237,0.18) }

    /* Actions */
    .actions{
      max-width:1200px;
      margin:14px auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
    }
    .actions input{ padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;min-width:260px }
    .actions .btn{ padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#041114;font-weight:700; cursor:pointer }
    .timer{ color:var(--muted); font-size:0.92rem }

    /* Layout */
    .container{
      max-width:1200px;
      margin:20px auto 60px;
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:18px;
      align-items:start;
    }
    .main{ min-height:300px }

    /* Cards grid: 2 por linha */
    .cards-grid{
      display:grid;
      grid-template-columns: repeat(2,1fr);
      gap:var(--gap);
    }
    .card{
      background:var(--card);
      color:var(--card-text);
      padding:12px 14px;
      border-radius:10px;
      box-shadow:0 6px 18px rgba(0,0,0,0.45);
      border-left:6px solid var(--editoria-color, var(--accent));
      display:flex;
      flex-direction:column;
      min-height:130px;
      /* per-card editoria color var (set inline by JS) */
      --editoria-color: var(--accent);
    }
    .card h3{margin:0 0 6px;font-size:1rem}
    .card h3 a{ color: var(--editoria-color); text-decoration:none }
    .card p{margin:0 0 8px;color:#333;flex:1;font-size:0.95rem; overflow:hidden; display:-webkit-box; -webkit-line-clamp:4; -webkit-box-orient:vertical}
    /* links dentro da descri√ß√£o tamb√©m herdam a cor da editoria */
    .card p a { color: var(--editoria-color); text-decoration:underline }
    .card small{color:#666;display:block;margin-bottom:6px}
    .meta-row{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .source-pill{background:rgba(0,0,0,0.03);padding:6px 8px;border-radius:999px;font-size:0.85rem;color:#444}
    .editoria-pill{background:var(--editoria-color);color:#041114;padding:6px 8px;border-radius:8px;font-weight:700;font-size:0.82rem}
    .subtags{display:inline-flex;gap:6px;align-items:center;margin-left:8px;flex-wrap:wrap}
    .subtag{background:rgba(0,0,0,0.05);color:var(--card-text);padding:4px 8px;border-radius:999px;font-size:0.75rem;font-weight:600;border:1px solid rgba(0,0,0,0.04)}
    .subtag.small{font-size:0.7rem;padding:3px 6px}

    /* Load more */
    .load-more-wrap{ display:flex; justify-content:center; margin:18px 0 }
    .btn-load-more{ padding:10px 14px; border-radius:10px; background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); cursor:pointer }

    /* sidebar */
    .sidebar{ position:relative }
    .sidebar h4{color:var(--accent); text-align:center; margin:0 0 8px}
    .sidebar .item{ background:var(--panel); border-radius:8px; padding:10px; margin-bottom:10px; color:var(--muted); border-left:4px solid rgba(255,255,255,0.03) }
    /* allow each .item to expose --editoria-color inline and have its link colored accordingly */
    .sidebar .item a{ color:var(--editoria-color, var(--accent)); text-decoration:underline; font-weight:600 }

    #contador-hoje{ color:var(--muted); text-align:center; margin-top:6px }

    @media (max-width:820px){ .container{ grid-template-columns:1fr } .cards-grid{ grid-template-columns:1fr } .sidebar{order:2} }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="brand">
          <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f6f0.png" alt="Radar" />
          <div>
            <div class="title">Radar de Not√≠cias</div>
            <div class="meta" style="font-size:0.82rem">Desenvolvido por <a href="mailto:guilherme.giuntini@telefonica.com">Guilherme Giuntini</a></div>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <div class="timer" id="refresh-timer">‚è≥ Atualiza√ß√£o autom√°tica em --:--</div>
        <button class="btn" id="btn-refresh" onclick="refreshNoticias()" title="Atualizar agora">üîÑ Atualizar agora</button>
      </div>
    </div>

    <!-- Menu √∫nico com editorias -->
    <div class="menu-area" id="menuArea" role="navigation" aria-label="Editorias principais"></div>

    <!-- A√ß√µes -->
    <div class="actions">
      <input id="termoBusca" type="text" placeholder="Buscar por palavra-chave (ex: elei√ß√µes, show, Copa do Mundo)" />
      <button class="btn" onclick="buscarPorPalavra()">Buscar</button>
    </div>

    <div style="max-width:1200px;margin:8px auto 0;text-align:center">
      <div id="contador-hoje">üî¢ Not√≠cias carregadas hoje: 0</div>
    </div>
  </header>

  <div class="container">
    <main class="main" id="noticias" aria-live="polite">
      <!-- cards-grid + load more -->
    </main>

    <aside class="sidebar" aria-label="Mais publicadas">
      <h4>Mais publicadas (√∫ltimas 5h)</h4>
      <div id="mais-publicadas"></div>
    </aside>
  </div>

<script>
/* Esta vers√£o:
 - Integra sub-t√≥picos para cada editoria (o mapeamento solicitado pelo usu√°rio).
 - Expande o classificador para detectar e atribuir subtags (subtopics) a cada artigo.
 - Exibe as subtags no card (pequenas "pills") pr√≥ximas √† editoria.
 - Mant√©m cores por editoria e demais melhorias j√° aplicadas.
*/

/* ---------------- CONFIGURA√á√ïES ---------------- */
const PAGE_SIZE = 20;
const CACHE_TTL_MS = 5 * 60 * 1000;
const MAX_CONCURRENCY = 6;
const FEED_PROXY = 'https://api.allorigins.win/get?url=';

/* ---------------- FEEDS E EDITORIAS ---------------- */
const feeds = [
  { nome: 'Tudo (GoogleNews *)', url: 'https://news.google.com/rss/search?q=*&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Principal (GoogleNews)', url: 'https://news.google.com/rss?hl=pt-BR&gl=BR&ceid=BR:pt-419' },

  { nome: 'Geral', url: 'https://news.google.com/rss/headlines/section/topic/NATION.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Brasil', url: 'https://news.google.com/rss/headlines/section/geo/Brasil?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Mundo', url: 'https://news.google.com/rss/headlines/section/topic/WORLD.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Pol√≠tica', url: 'https://news.google.com/rss/headlines/section/topic/POLITICS.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Economia', url: 'https://news.google.com/rss/headlines/section/topic/BUSINESS.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Ci√™ncia', url: 'https://news.google.com/rss/headlines/section/topic/SCIENCE.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Sa√∫de', url: 'https://news.google.com/rss/headlines/section/topic/HEALTH.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Educa√ß√£o', url: 'https://news.google.com/rss/search?q=educa√ß√£o&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Meio Ambiente', url: 'https://news.google.com/rss/search?q=meio+ambiente&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Tecnologia', url: 'https://news.google.com/rss/headlines/section/topic/TECHNOLOGY.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Neg√≥cios', url: 'https://news.google.com/rss/search?q=neg√≥cios&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Cultura', url: 'https://news.google.com/rss/search?q=cultura&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Entretenimento', url: 'https://news.google.com/rss/headlines/section/topic/ENTERTAINMENT.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Arte', url: 'https://news.google.com/rss/search?q=arte&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Moda', url: 'https://news.google.com/rss/search?q=moda&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Culin√°ria', url: 'https://news.google.com/rss/search?q=culin√°ria&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Turismo', url: 'https://news.google.com/rss/search?q=turismo&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Religi√£o', url: 'https://news.google.com/rss/search?q=religi√£o&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Carreira', url: 'https://news.google.com/rss/search?q=carreira&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Opini√£o', url: 'https://news.google.com/rss/search?q=opini√£o&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Esportes', url: 'https://news.google.com/rss/headlines/section/topic/SPORTS.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' }
];

const EDITORIAS = [
  'Todas','Geral','Brasil','Mundo','Pol√≠tica','Economia','Ci√™ncia','Sa√∫de',
  'Educa√ß√£o','Meio Ambiente','Tecnologia','Neg√≥cios','Cultura','Entretenimento',
  'Arte','Moda','Culin√°ria','Turismo','Religi√£o','Carreira','Opini√£o','Esportes'
];

/* ---------------- EDITORIA COLORS (hex) ---------------- */
const EDITORIA_COLORS = {
  'Todas': '#00aced',
  'Geral': '#6c757d',
  'Brasil': '#2e7d32',
  'Mundo': '#6a1b9a',
  'Pol√≠tica': '#d32f2f',
  'Economia': '#ff9800',
  'Ci√™ncia': '#00897b',
  'Sa√∫de': '#43a047',
  'Educa√ß√£o': '#3949ab',
  'Meio Ambiente': '#2e7d32',
  'Tecnologia': '#00bcd4',
  'Neg√≥cios': '#ffb300',
  'Cultura': '#8e24aa',
  'Entretenimento': '#e91e63',
  'Arte': '#7b1fa2',
  'Moda': '#ff4081',
  'Culin√°ria': '#6d4c41',
  'Turismo': '#00796b',
  'Religi√£o': '#5d4037',
  'Carreira': '#1976d2',
  'Opini√£o': '#fb8c00',
  'Esportes': '#388e3c'
};

/* ---------------- SUB-T√ìPICOS (subtopics) por editoria ----------------
   Aqui mapeei os sub-t√≥picos que voc√™ listou. Cada entrada tem termos que o detector
   usar√° para sinalizar subtags nos artigos.
*/
const SUBTOPICS = {
  'Tecnologia': [
    'intelig√™ncia artificial','ia','artificial intelligence','reviews','reviews de produtos',
    'celular','smartphone','notebook','computador','computadores','games','consoles','aplicativo','app',
    'redes sociais','ciberseguran√ßa','hardware','inova√ß√£o','inova√ß√µes','tend√™ncias','ci√™ncia','espa√ßo',
    've√≠culos','carro aut√¥nomo','aut√¥nomo','startup','neg√≥cios tech','5g','6g','tutorial','dicas','memes','virais','streaming','programa√ß√£o','desenvolvimento'
  ],
  'Brasil': [
    'pol√≠tica nacional','estadual','governo estadual','prefeitura','cidade','seguran√ßa p√∫blica','servi√ßos','infraestrutura','direitos humanos'
  ],
  'Mundo': [
    'not√≠cias internacionais','conflito','guerra','diplomacia','pol√≠tica global','am√©rica latina','europe','asia','asia pacifico'
  ],
  'Pol√≠tica': [
    'executivo','congresso','legislativo','judici√°rio','elei√ß√µes','partido','pol√≠tica p√∫blica','corrup√ß√£o'
  ],
  'Economia': [
    'infla√ß√£o','juros','c√¢mbio','d√≥lar','bolsa','investimento','agroneg√≥cio','ind√∫stria','com√©rcio','finan√ßas pessoais'
  ],
  'Ci√™ncia': [
    'espa√ßo','astronomia','descoberta','pesquisa','meio ambiente','paleontologia','biologia'
  ],
  'Sa√∫de': [
    'bem-estar','doen√ßa','tratamento','nutri√ß√£o','sa√∫de mental','vacina','sus','fitness'
  ],
  'Educa√ß√£o': [
    'ensino b√°sico','ensino superior','vestibular','enem','tecnologia na educa√ß√£o','curso','interc√¢mbio'
  ],
  'Meio Ambiente': [
    'mudan√ßa clim√°tica','desmatamento','sustentabilidade','biodiversidade','reciclagem','energias renov√°veis','desastre ambiental'
  ],
  'Neg√≥cios': [
    'empresa','empreendedorismo','gest√£o','marketing','finan√ßas corporativas','fus√£o','aquisicao','varejo'
  ],
  'Cultura': [
    'm√∫sica','cinema','s√©ries','streaming','livros','teatro','exposi√ß√£o','famosos'
  ],
  'Entretenimento': [
    'celebridade','famoso','subcelebridade','bbb','big brother','a fazenda','reality','fofoca','memes','virais','musica pop'
  ],
  'Arte': ['artes pl√°sticas','exposi√ß√£o','museu','fotografia','design'],
  'Moda': ['tend√™ncia','desfile','beleza','designer','sustentabilidade moda'],
  'Culin√°ria': ['receita','restaurante','chef','gastronomia','vinho'],
  'Turismo': ['destino','hotel','passagem','ecoturismo'],
  'Religi√£o': ['evento religioso','vaticano','debate f√©'],
  'Carreira': ['emprego','entrevista','concurso','desenvolvimento profissional'],
  'Opini√£o': ['coluna','editorial','an√°lise'],
  'Esportes': [
    'futebol masculino','futebol feminino','futebol','volei','v√¥lei','volei de praia','v√¥lei de praia','basquete','futsal',
    'handebol','formula 1','f√≥rmula 1','stock car','motogp','mma','boxe','jud√¥','judo','surfe','skate','t√™nis','tenis',
    'nata√ß√£o','natacao','atletismo','gin√°stica art√≠stica','futebol americano','e-sports','esports'
  ]
};

/* ---------------- CLASSIFICADOR HEUR√çSTICO ---------------- */
/* Mantive a lista KEYWORDS usada para pontuar editorias (pode ser usada em conjunto com SUBTOPICS). */
const KEYWORDS = {
  'Pol√≠tica': ['presidente','governo','ministro','parlamento','deputado','senador','congresso','eleicao','politica'],
  'Economia': ['economia','banco','juros','inflat','ibge','cambio','bolsa','mercado','investimento','pib'],
  'Ci√™ncia': ['pesquisa','cientifico','laboratorio','cientista','descoberta','estudo'],
  'Sa√∫de': ['saude','hospital','vacina','epidemia','pandemia','sintoma','paciente','medico'],
  'Educa√ß√£o': ['escola','ensino','universidade','professor','aluno','vestibular'],
  'Meio Ambiente': ['clima','desmatamento','sustentabilidade','emissao','fauna','flora'],
  'Tecnologia': ['tecnologia','aplicativo','app','inteligencia artificial','ia','startup','software','hardware','gadget','criptomoeda','blockchain','celular','smartphone','notebook','computador','games','streaming','programa√ß√£o','desenvolvimento'],
  'Neg√≥cios': ['empresa','fusao','aquisicao','ceo','executivo','investidor','contrato','financas'],
  'Cultura': ['cultura','festival','museu','exposicao'],
  'Entretenimento': ['filme','cinema','estreia','serie','turne','entrevista','show','famoso','celebridade','bbb','a fazenda','reality','fofoca'],
  'Arte': ['arte','obra','galeria','pintura','escultura'],
  'Moda': ['moda','desfile','estilista','colecao','tendencia'],
  'Culin√°ria': ['culinaria','receita','chefe','restaurante','gastronomia'],
  'Turismo': ['turismo','destino','hotel','viagem','roteiro'],
  'Religi√£o': ['igreja','religiao','culto','padre','pastor','fe'],
  'Carreira': ['carreira','emprego','vaga','salario','recrutamento'],
  'Opini√£o': ['opiniao','coluna','editorial'],
  'Esportes': ['futebol','volei','v√¥lei','basquete','futsal','handebol','formula 1','stock car','motogp','mma','boxe','jud√¥','surfe','skate','t√™nis','nata√ß√£o','atletismo','ginastica']
};

/* ---------------- ESTADO ---------------- */
let noticiasAtuais = [];
let displayedCount = 0;
let editoriaAtiva = 'Todas';
let isLoading = false;

/* ---------------- UTILIDADES ---------------- */
function normalize(s){
  return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
}
function formatDate(pub){
  if(!pub) return '';
  const d = new Date(pub);
  if(isNaN(d)) return '';
  return d.toLocaleString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false }).replace(',', ' -');
}
function isToday(pub){
  if(!pub) return false;
  const d = new Date(pub);
  if(isNaN(d)) return false;
  const n = new Date();
  return d.getFullYear()===n.getFullYear() && d.getMonth()===n.getMonth() && d.getDate()===n.getDate();
}
function hexToRgb(hex){
  if(!hex) return null;
  const h = hex.replace('#','');
  if(h.length === 3) {
    return { r: parseInt(h[0]+h[0],16), g: parseInt(h[1]+h[1],16), b: parseInt(h[2]+h[2],16) };
  }
  return { r: parseInt(h.substring(0,2),16), g: parseInt(h.substring(2,4),16), b: parseInt(h.substring(4,6),16) };
}
function isColorLight(hex){
  try{
    const rgb = hexToRgb(hex);
    if(!rgb) return false;
    // relative luminance formula
    const r = rgb.r/255, g = rgb.g/255, b = rgb.b/255;
    const lum = 0.2126*r + 0.7152*g + 0.0722*b;
    return lum > 0.6;
  }catch(e){
    return false;
  }
}

/* ---------------- CACHE (localStorage) ---------------- */
function cacheKey(url){ return 'rsscache:' + btoa(url); }
function readCache(url){
  try{
    const raw = localStorage.getItem(cacheKey(url));
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj.ts || (Date.now() - obj.ts) > CACHE_TTL_MS) {
      localStorage.removeItem(cacheKey(url));
      return null;
    }
    return obj.contents;
  }catch(e){
    return null;
  }
}
function writeCache(url, contents){
  try{
    const obj = { ts: Date.now(), contents };
    localStorage.setItem(cacheKey(url), JSON.stringify(obj));
  }catch(e){}
}

/* ---------------- FETCH RSS (com cache e proxy) ---------------- */
async function fetchRssRaw(url){
  const cached = readCache(url);
  if(cached) {
    return cached;
  }
  try {
    const r = await fetch(FEED_PROXY + encodeURIComponent(url));
    if(!r.ok) throw new Error('proxy-fail');
    const data = await r.json();
    if(data && data.contents) {
      writeCache(url, data.contents);
      return data.contents;
    }
    return '';
  } catch(e) {
    console.warn('Erro ao buscar feed:', url, e);
    return '';
  }
}
function parseItemsFromXmlString(xmlStr){
  try{
    const parser = new DOMParser();
    const doc = parser.parseFromString(xmlStr, 'application/xml');
    const items = Array.from(doc.querySelectorAll('item'));
    return items;
  }catch(e){
    return [];
  }
}

/* ---------------- THROTTLED BATCH FETCH ---------------- */
async function fetchAllFeedsBatched(feedList){
  const results = [];
  const queue = [...feedList];
  const workers = new Array(MAX_CONCURRENCY).fill(0).map(async () => {
    while(queue.length){
      const f = queue.shift();
      try{
        const raw = await fetchRssRaw(f.url);
        const items = raw ? parseItemsFromXmlString(raw) : [];
        const mapped = items.map(it => {
          const title = it.querySelector('title')?.textContent || '(sem t√≠tulo)';
          const link = it.querySelector('link')?.textContent || it.querySelector('guid')?.textContent || '#';
          const desc = it.querySelector('description')?.textContent || '';
          const pubDate = it.querySelector('pubDate')?.textContent || '';
          const source = (()=>{ try { return new URL(link).hostname.replace('www.',''); } catch(e){ return ''; } })();
          return { title: title.trim(), link, desc: desc.trim(), pubDate, source };
        });
        results.push(...mapped);
      }catch(e){
        console.warn('Erro processando feed', f.url, e);
      }
    }
  });
  await Promise.all(workers);
  return results;
}

/* ---------------- DETECT SUBTOPICS ---------------- */
function detectSubtopics(title, desc, editoria){
  const text = (title + ' ' + (desc||'')).toLowerCase();
  const subs = [];
  const list = SUBTOPICS[editoria] || [];
  for(const term of list){
    const k = term.toLowerCase();
    // word-boundary friendly check for multiword phrases
    const regex = new RegExp('\\b' + k.replace(/\s+/g,'\\s+') + '\\b','i');
    if(regex.test(text) && !subs.includes(term)) subs.push(term);
  }
  return subs;
}

/* ---------------- CLASSIFICADOR ---------------- */
function classifyArticle(title, desc){
  const textTitle = normalize(title);
  const textDesc = normalize(desc);

  // Quick entertainment override for strong terms
  const entertainmentEarly = ['famoso','famosos','celebridade','celebridades','subcelebridade','bbb','big brother','a fazenda','reality','fofoca','memes','virais'];
  for(const t of entertainmentEarly){
    if(textTitle.includes(t) || textDesc.includes(t)) return 'Entretenimento';
  }

  let best = 'Geral';
  let bestScore = 0;
  for(const [editoria, keywords] of Object.entries(KEYWORDS)){
    let score = 0;
    for(const raw of keywords){
      const k = normalize(raw);
      const regex = new RegExp('\\b' + k.replace(/\s+/g,'\\s+') + '\\b','i');
      if(regex.test(textTitle)) score += 2;
      else if(textTitle.includes(k)) score += 0.5;
      if(regex.test(textDesc)) score += 1;
      else if(textDesc.includes(k)) score += 0.5;
    }
    if(score > bestScore){
      bestScore = score;
      best = editoria;
    }
  }
  if(bestScore < 1) return 'Geral';
  return best;
}

/* ---------------- RENDER UI ---------------- */
function renderEditoriasMenu(){
  const menu = document.getElementById('menuArea');
  menu.innerHTML = '';
  EDITORIAS.forEach(name => {
    const btn = document.createElement('button');
    btn.className = 'editoria-btn';
    btn.textContent = name;
    btn.setAttribute('data-editoria', name);
    const color = EDITORIA_COLORS[name] || getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#00aced';
    btn.style.background = `linear-gradient(90deg, ${color}, ${shadeColor(color,12)})`;
    btn.style.color = isColorLight(color) ? '#041114' : '#fff';
    btn.onclick = () => { filterByEditoria(name); };
    menu.appendChild(btn);
  });
  highlightActiveEditorias();
}
function highlightActiveEditorias(){
  const btns = document.querySelectorAll('.editoria-btn');
  btns.forEach(b => {
    const isActive = b.textContent === editoriaAtiva;
    b.classList.toggle('active', isActive);
    const color = EDITORIA_COLORS[b.getAttribute('data-editoria')] || getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
    if(isActive){
      b.style.boxShadow = `0 10px 30px ${hexToRgba(color, 0.18)}`;
    } else {
      b.style.boxShadow = `0 6px 16px ${hexToRgba(color, 0.08)}`;
    }
  });
}

/* small helpers to shade and rgba from hex */
function shadeColor(hex, percent) {
  try{
    let {r,g,b} = hexToRgb(hex);
    r = Math.min(255, Math.round(r + (percent/100)*255));
    g = Math.min(255, Math.round(g + (percent/100)*255));
    b = Math.min(255, Math.round(b + (percent/100)*255));
    return `rgb(${r},${g},${b})`;
  }catch(e){
    return hex;
  }
}
function hexToRgba(hex, alpha){
  try{
    const c = hexToRgb(hex);
    return `rgba(${c.r},${c.g},${c.b},${alpha})`;
  }catch(e){
    return `rgba(0,172,237,${alpha})`;
  }
}

function renderCardsPaged(items){
  const main = document.getElementById('noticias');
  if(displayedCount === 0) main.innerHTML = '';
  let grid = main.querySelector('.cards-grid');
  if(!grid){
    grid = document.createElement('div'); grid.className = 'cards-grid';
    main.appendChild(grid);
  }
  const slice = items.slice(displayedCount, displayedCount + PAGE_SIZE);
  slice.forEach(a => {
    const card = document.createElement('article');
    card.className = 'card';
    const color = EDITORIA_COLORS[a.editoria] || EDITORIA_COLORS['Todas'] || getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
    card.style.setProperty('--editoria-color', color);

    // compute subtags for display (if not already present)
    if(!a.subtags) a.subtags = detectSubtopics(a.title, a.desc, a.editoria);

    // render card with subtags (show up to 3)
    const subtagsHtml = (a.subtags && a.subtags.length) ? `<div class="subtags">${a.subtags.slice(0,3).map(s => `<span class="subtag small">${escapeHtml(s)}</span>`).join('')}</div>` : '';

    card.innerHTML = `
      <h3><a href="${escapeHtmlAttr(a.link)}" target="_blank" rel="noopener noreferrer">${escapeHtml(a.title)}</a></h3>
      <p>${a.desc || ''}</p>
      <div class="meta-row">
        <div style="display:flex;gap:8px;align-items:center">
          <div class="source-pill">${escapeHtml(a.source)}</div>
          <div style="display:flex;gap:6px;align-items:center">
            <div class="editoria-pill">${escapeHtml(a.editoria)}</div>
            ${subtagsHtml}
          </div>
        </div>
      </div>`;
    grid.appendChild(card);
    const pill = card.querySelector('.editoria-pill');
    if(pill){
      pill.style.color = isColorLight(color) ? '#041114' : '#fff';
    }
  });
  displayedCount += slice.length;
  document.getElementById('contador-hoje').textContent = `üî¢ Not√≠cias exibidas: ${displayedCount} / ${items.length}`;
  renderLoadMoreIfNeeded(items.length);
}
function renderLoadMoreIfNeeded(total){
  const existing = document.querySelector('.load-more-wrap');
  if(existing) existing.remove();
  if(displayedCount >= total) return;
  const main = document.getElementById('noticias');
  const wrap = document.createElement('div');
  wrap.className = 'load-more-wrap';
  const btn = document.createElement('button');
  btn.className = 'btn-load-more';
  btn.textContent = 'Carregar mais';
  btn.onclick = () => {
    const currentList = getCurrentFilteredList();
    renderCardsPaged(currentList);
  };
  wrap.appendChild(btn);
  main.appendChild(wrap);
}

/* ---------------- SIDEBAR: mais publicadas (√∫ltimas 5h) ---------------- */
function updateSidebarFrom(list, limit = null){
  const container = document.getElementById('mais-publicadas');
  container.innerHTML = '';
  if(!list || list.length === 0){
    container.innerHTML = `<div style="color:var(--muted)">Sem dados recentes.</div>`;
    return;
  }
  const now = new Date();
  const fiveHoursAgo = new Date(now.getTime() - 5*60*60*1000);
  const map = {};
  list.forEach(a => {
    if(!a.pubDate) return;
    const pub = new Date(a.pubDate);
    if(isNaN(pub) || pub < fiveHoursAgo) return;
    const key = a.title.toLowerCase().replace(/[^\w\s]/g,'').slice(0,180);
    if(!map[key]) map[key] = { count:0, item: a, latest: pub };
    map[key].count++;
    if(pub > map[key].latest) map[key].latest = pub;
  });
  const defaultLimit = (editoriaAtiva && editoriaAtiva !== 'Todas') ? 5 : 12;
  const useLimit = Number.isInteger(limit) ? limit : defaultLimit;
  const arr = Object.values(map).sort((x,y) => y.count - x.count || y.latest - x.latest).slice(0,useLimit);
  if(arr.length === 0){
    container.innerHTML = `<div style="color:var(--muted)">Sem publica√ß√µes nas √∫ltimas 5 horas.</div>`;
    return;
  }
  arr.forEach(entry => {
    const a = entry.item;
    const div = document.createElement('div');
    div.className = 'item';
    const color = EDITORIA_COLORS[a.editoria] || EDITORIA_COLORS['Todas'] || getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
    div.style.setProperty('--editoria-color', color);
    div.innerHTML = `<a href="${escapeHtmlAttr(a.link)}" target="_blank" rel="noopener noreferrer">${escapeHtml(a.title)}</a>
      <div style="margin-top:6px;color:var(--muted);font-size:0.88rem">üóû ${escapeHtml(a.source)} ‚Ä¢ ${formatDate(a.pubDate)} ${entry.count>1?` ‚Ä¢ √ó${entry.count}`:''}</div>`;
    container.appendChild(div);
  });
}

/* ---------------- FILTRAGEM E PAGINA√á√ÉO ---------------- */
function getCurrentFilteredList(){
  if(editoriaAtiva === 'Todas') return noticiasAtuais;
  // special handling for Esportes: include football-associated cross-articles already covered by SUBTOPICS detection
  if(editoriaAtiva === 'Esportes'){
    return noticiasAtuais.filter(a => {
      try{
        if(a.editoria === 'Esportes') return true;
        // include if any sports subtopic detected and contains 'futebol' or related
        const subs = detectSubtopics(a.title, a.desc, a.editoria || 'Geral');
        // if article mentions 'futebol' together with other sports terms we include it
        const txt = (a.title + ' ' + (a.desc||'')).toLowerCase();
        if(txt.includes('futebol') || txt.includes('futebol masculino') || txt.includes('futebol feminino')) return true;
        // or if it has any subtopic from Esportes list
        return subs.some(s => SUBTOPICS['Esportes'].some(es => s.toLowerCase().includes(es)));
      }catch(e){
        return false;
      }
    });
  }
  return noticiasAtuais.filter(a => a.editoria === editoriaAtiva);
}
function resetPaginationAndRender(){
  displayedCount = 0;
  const list = getCurrentFilteredList();
  const main = document.getElementById('noticias');
  main.innerHTML = '';
  renderCardsPaged(list);
  updateSidebarFrom(list);
}

/* ---------------- MAIN LOADER ---------------- */
async function carregarTodasHoje(){
  if(isLoading) return;
  setLoading(true);
  editoriaAtiva = 'Todas';
  highlightActiveEditorias();
  document.getElementById('noticias').innerHTML = `<div style="color:var(--muted);padding:12px;border-radius:8px">Carregando not√≠cias (coletando feeds) ‚Äî isso pode levar alguns segundos...</div>`;
  try{
    const all = await fetchAllFeedsBatched(feeds);
    const today = all.filter(a => isToday(a.pubDate));
    const classified = today.map(a => {
      const editoria = classifyArticle(a.title, a.desc);
      const subtags = detectSubtopics(a.title, a.desc, editoria);
      return {
        title: a.title,
        link: a.link,
        desc: a.desc,
        pubDate: a.pubDate,
        source: a.source || '',
        editoria,
        subtags
      };
    });
    classified.sort((x,y)=> new Date(y.pubDate||0) - new Date(x.pubDate||0));
    noticiasAtuais = classified;
    displayedCount = 0;
    resetPaginationAndRender();
  }catch(e){
    console.error('Erro ao carregar todas as not√≠cias', e);
    document.getElementById('noticias').innerHTML = `<div style="color:var(--muted);padding:12px;border-radius:8px">Erro ao carregar not√≠cias. Tente novamente.</div>`;
  } finally {
    setLoading(false);
  }
}

/* ---------------- FILTRO POR EDITORIA (menu) ---------------- */
function filterByEditoria(name){
  if(isLoading) return;
  editoriaAtiva = name;
  highlightActiveEditorias();
  displayedCount = 0;
  resetPaginationAndRender();
}

/* ---------------- BUSCA ---------------- */
async function buscarPorPalavra(){
  const termo = document.getElementById('termoBusca').value.trim();
  if(!termo) {
    return carregarTodasHoje();
  }
  if(isLoading) return;
  setLoading(true);
  document.getElementById('noticias').innerHTML = `<div style="color:var(--muted);padding:12px;border-radius:8px">Buscando "${escapeHtml(termo)}" em not√≠cias de hoje...</div>`;
  try{
    const rssUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(termo)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`;
    const raw = await fetchRssRaw(rssUrl);
    const items = raw ? parseItemsFromXmlString(raw) : [];
    const mapped = items.map(it => {
      const title = it.querySelector('title')?.textContent || '(sem t√≠tulo)';
      const link = it.querySelector('link')?.textContent || '#';
      const desc = it.querySelector('description')?.textContent || '';
      const pubDate = it.querySelector('pubDate')?.textContent || '';
      const source = (()=>{ try { return new URL(link).hostname.replace('www.',''); } catch(e){ return ''; } })();
      return { title: title.trim(), link, desc: desc.trim(), pubDate, source };
    }).filter(a => isToday(a.pubDate));
    const classified = mapped.map(a => {
      const editoria = classifyArticle(a.title, a.desc);
      const subtags = detectSubtopics(a.title, a.desc, editoria);
      return { ...a, editoria, subtags };
    });
    classified.sort((a,b)=> new Date(b.pubDate||0) - new Date(a.pubDate||0));
    noticiasAtuais = classified;
    editoriaAtiva = 'Todas';
    displayedCount = 0;
    resetPaginationAndRender();
  }catch(e){
    console.error('Erro ao buscar', e);
    document.getElementById('noticias').innerHTML = `<div style="color:var(--muted);padding:12px;border-radius:8px">Erro na busca. Tente novamente.</div>`;
  } finally {
    setLoading(false);
  }
}

/* ---------------- LOADING STATE ---------------- */
function setLoading(flag){
  isLoading = flag;
  const allButtons = document.querySelectorAll('.editoria-btn, .btn, .btn-load-more');
  allButtons.forEach(b => b.disabled = flag);
}

/* ---------------- AUTO REFRESH ---------------- */
let refreshIntervalSec = 15 * 60;
let refreshCountdown = refreshIntervalSec;
let refreshTimerId = null;
function atualizarTimer(){
  const el = document.getElementById('refresh-timer');
  if(!el) return;
  const m = String(Math.floor(refreshCountdown/60)).padStart(2,'0');
  const s = String(refreshCountdown%60).padStart(2,'0');
  el.textContent = `‚è≥ Atualiza√ß√£o autom√°tica em ${m}:${s}`;
}
function iniciarAutoRefresh(){
  if(refreshTimerId) clearInterval(refreshTimerId);
  refreshCountdown = refreshIntervalSec;
  atualizarTimer();
  refreshTimerId = setInterval(()=>{
    refreshCountdown--;
    if(refreshCountdown <= 0){
      refreshCountdown = refreshIntervalSec;
      carregarTodasHoje();
    }
    atualizarTimer();
  }, 1000);
}
function refreshNoticias(){
  carregarTodasHoje();
  refreshCountdown = refreshIntervalSec;
  atualizarTimer();
}

/* ---------------- INICIALIZA√á√ÉO ---------------- */
function init(){
  renderEditoriasMenu();
  carregarTodasHoje();
  iniciarAutoRefresh();
  document.getElementById('termoBusca').addEventListener('keydown', e => {
    if(e.key === 'Enter') buscarPorPalavra();
  });
  window.addEventListener('scroll', () => {
    const more = document.querySelector('.btn-load-more');
    if(!more) return;
    const rect = more.getBoundingClientRect();
    if(rect.top < window.innerHeight + 100) {
      if(!isLoading) more.click();
    }
  }, { passive: true });
}

/* ---------------- small safe helpers ---------------- */
function escapeHtml(s){
  if(!s) return '';
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}
function escapeHtmlAttr(s){
  if(!s) return '';
  return String(s).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

init();

</script>
</body>
</html>
