<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Radar de Notícias</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: #f0f0f0;
      margin: 0;
      padding: 0;
    }
    header {
      background: #1e1e1e;
      color: white;
      padding: 1em;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .titulo-radar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5em;
      font-size: 1.5em;
    }
    .titulo-radar img {
      width: 32px;
      height: 32px;
      vertical-align: middle;
    }
    nav, .busca {
      text-align: center;
      margin: 1em 0;
      flex-wrap: wrap;
    }
    nav button, .busca button, #btn-atualizar-tudo {
      margin: 5px;
      padding: 0.5em 1em;
      background: #00aced;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      outline: none;
    }
    nav button.active {
      background: #0077a3;
      font-weight: bold;
    }
    nav button:hover, .busca button:hover, #btn-atualizar-tudo:hover {
      background: #0077a3;
    }
    #btn-atualizar-tudo {
      background: #0d8f4f;
      font-weight: bold;
      margin-bottom: 1em;
    }
    .busca input {
      padding: 0.5em;
      width: 200px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .contador {
      text-align: center;
      font-weight: bold;
      margin: 1em 0;
    }
    #custom-editorias-bar {
      margin: 0.5em 0;
      text-align: center;
    }
    #custom-editorias-bar button {
      background: #444;
      border: none;
      color: #fff;
      border-radius: 5px;
      margin: 0 5px;
      cursor: pointer;
      padding: 0.3em 0.7em;
      font-size: 0.95em;
    }
    #custom-editorias-bar button.selected {
      background: #00aced;
      font-weight: bold;
    }
    #custom-editorias-bar button.remove {
      background: #b71c1c;
      margin-left: 0.25em;
      padding: 0.2em 0.4em;
    }
    #config-editoria {
      background: #222;
      padding: 1em;
      border-radius: 8px;
      margin: 1em 0;
      color: #fff;
      display: none;
    }
    #config-editoria label, #config-editoria input, #config-editoria select {
      margin: 0.3em;
    }
    #noticias {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1em;
      padding: 1em;
    }
    .card {
      background: #ffffff;
      color: #000000;
      padding: 1em;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(255,255,255,0.1);
      position: relative;
      border-left: 8px solid transparent;
      transition: border-color 0.2s;
    }
    .card.breaking {
      border-left: 8px solid #ff2e00;
      background: #fff3f0;
      animation: destaque 1s infinite alternate;
    }
    @keyframes destaque {
      from { box-shadow: 0 0 16px 2px #ff2e0033; }
      to { box-shadow: 0 0 24px 4px #ff2e0022; }
    }
    .breaking-label {
      position: absolute;
      top: 8px;
      left: -1px;
      background: #ff2e00;
      color: #fff;
      font-size: 0.95em;
      padding: 2px 8px;
      border-radius: 0 4px 4px 0;
      font-weight: bold;
      z-index: 2;
    }
    .card h3 {
      margin: 0.5em 0;
    }
    .card p {
      color: #333;
    }
    #filtro-data-bar {
      margin: 1em 0 0.3em 0;
      text-align: center;
      color: #fff;
      font-size: 0.98em;
    }
    #filtro-data-bar select {
      margin-left: 0.5em;
      padding: 0.2em 0.6em;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    @media (max-width: 600px) {
      nav button, .busca button, #btn-atualizar-tudo {
        width: 90%;
        margin: 5px auto;
        display: block;
      }
      .busca input {
        width: 90%;
      }
      #noticias {
        grid-template-columns: 1fr;
      }
      .titulo-radar {
        font-size: 1.1em;
      }
      .titulo-radar img {
        width: 24px;
        height: 24px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="titulo-radar">
      <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f6f0.png" alt="Radar Icon" />
      <span>Radar de Notícias</span>
    </div>
    <button id="btn-atualizar-tudo" onclick="atualizarTodasEditoriasHoje()">Atualizar notícias de todas as editorias (HOJE)</button>
    <nav id="editorias"></nav>
    <div id="custom-editorias-bar"></div>
    <button id="btn-personalizar" onclick="abrirConfigEditoria()">Personalizar Editorias</button>
    <div id="config-editoria">
      <label><strong>Adicionar editoria:</strong>
        <select id="select-editoria"></select>
      </label>
      <button onclick="adicionarEditoriaPersonalizada()">Adicionar</button>
      <button onclick="fecharConfigEditoria()">Fechar</button>
    </div>
    <div class="busca">
      <input type="text" id="termoBusca" placeholder="Buscar por palavra-chave">
      <button onclick="buscarPorPalavra()">Buscar</button>
    </div>
    <div id="filtro-data-bar">
      <label for="filtro-data">Filtrar por data: </label>
      <select id="filtro-data" onchange="aplicarFiltroData()">
        <option value="tudo">Tudo</option>
        <option value="hoje">Hoje</option>
        <option value="ontem">Ontem</option>
        <option value="semana">Última semana</option>
        <option value="mes">Último mês</option>
      </select>
    </div>
    <div class="contador" id="contador"></div>
  </header>
  <main id="noticias"></main>
  <script>
const feeds = [
  { nome: 'Geral', url: 'https://news.google.com/rss?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Mundo', url: 'https://news.google.com/rss/headlines/section/topic/WORLD.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Política', url: 'https://news.google.com/rss/headlines/section/topic/POLITICS.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Negócios', url: 'https://news.google.com/rss/headlines/section/topic/BUSINESS.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Ciência', url: 'https://news.google.com/rss/headlines/section/topic/SCIENCE.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Saúde', url: 'https://news.google.com/rss/headlines/section/topic/HEALTH.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Tecnologia', url: 'https://news.google.com/rss/headlines/section/topic/TECHNOLOGY.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Esportes', url: 'https://news.google.com/rss/headlines/section/topic/SPORTS.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Entretenimento', url: 'https://news.google.com/rss/headlines/section/topic/ENTERTAINMENT.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Brasil', url: 'https://news.google.com/rss/headlines/section/geo/Brasil?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Economia', url: 'https://news.google.com/rss/search?q=economia&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Educação', url: 'https://news.google.com/rss/search?q=educação&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Carreira', url: 'https://news.google.com/rss/search?q=carreira&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Meio Ambiente', url: 'https://news.google.com/rss/search?q=meio+ambiente&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Arte', url: 'https://news.google.com/rss/search?q=arte&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Opinião', url: 'https://news.google.com/rss/search?q=opinião&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Moda', url: 'https://news.google.com/rss/search?q=moda&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Culinária', url: 'https://news.google.com/rss/search?q=culinária&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Turismo', url: 'https://news.google.com/rss/search?q=turismo&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
  { nome: 'Religião', url: 'https://news.google.com/rss/search?q=religião&hl=pt-BR&gl=BR&ceid=BR:pt-419' }
];

let customEditorias = [];
let noticiasAtuais = [];
let noticiasFiltradas = [];
let editoriaAtual = 0;
let filtroDataAtual = 'tudo';

// Novidade: Carregar notícias de todas editorias de hoje
async function atualizarTodasEditoriasHoje() {
  document.getElementById("noticias").innerHTML = "<p>Carregando notícias de todas as editorias de hoje...</p>";
  atualizarContador(0);

  const todasNoticias = [];
  for (const feed of feeds) {
    try {
      const resp = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(feed.url)}`);
      const data = await resp.json();
      const parser = new DOMParser();
      const xml = parser.parseFromString(data.contents, "application/xml");
      const items = Array.from(xml.querySelectorAll("item"));
      // Pegue apenas notícias de hoje
      const hoje = new Date();
      hoje.setHours(0,0,0,0);
      items.forEach(item => {
        const pubDate = item.querySelector("pubDate")?.textContent;
        if (!pubDate) return;
        const dataNoticia = new Date(pubDate);
        // Ajuste para timezone local
        const localData = new Date(dataNoticia.getFullYear(), dataNoticia.getMonth(), dataNoticia.getDate());
        if (localData.getTime() === hoje.getTime()) {
          todasNoticias.push(item);
        }
      });
    } catch (err) {
      // Ignore falhas individuais de feed
    }
  }
  // Ordena todas por data (mais recente primeiro)
  todasNoticias.sort((a, b) => {
    const dateA = new Date(a.querySelector("pubDate")?.textContent || 0);
    const dateB = new Date(b.querySelector("pubDate")?.textContent || 0);
    return dateB - dateA;
  });
  noticiasAtuais = todasNoticias;
  filtroDataAtual = 'hoje';
  exibirNoticias(noticiasAtuais);
}

function salvarCustomEditorias() {
  localStorage.setItem('customEditorias', JSON.stringify(customEditorias));
}
function carregarCustomEditorias() {
  const saved = localStorage.getItem('customEditorias');
  if (saved) {
    customEditorias = JSON.parse(saved);
  } else {
    // Por padrão mostrar as 3 principais
    customEditorias = [0,1,2];
    salvarCustomEditorias();
  }
}
function atualizarContador(qtd) {
  document.getElementById("contador").textContent = `🔢 Total de notícias exibidas: ${qtd}`;
}

function formatarDataAMPM(dataStr) {
  if (!dataStr) return "";
  const data = new Date(dataStr);
  if (isNaN(data)) return "";
  return data.toLocaleString('pt-BR', {
    day: '2-digit', month: '2-digit', year: 'numeric',
    hour: '2-digit', minute: '2-digit', hour12: true
  }).replace(',', ' -');
}

function isBreakingNews(title, description) {
  // Critérios de destaque ("breaking news"):
  // - Palavras no título: urgente, breaking, última hora, alerta, emergência, importante
  // - OU: termo "Breaking News" no description, ou título todo em maiúsculo e curto
  const crits = /(\burgente\b|\bbreaking\b|última hora|alerta|emergência|importante)/i;
  if (crits.test(title) || crits.test(description)) return true;
  if (/BREAKING NEWS/i.test(description)) return true;
  if (title.length < 50 && /^[A-ZÁÉÍÓÚÂÊÔÃÕÇ0-9 \-!?:]+$/.test(title)) return true;
  return false;
}

function exibirNoticias(lista) {
  const noticias = document.getElementById("noticias");
  noticias.innerHTML = "";
  if (!lista.length) {
    noticias.innerHTML = "<p>Nenhuma notícia encontrada.</p>";
    atualizarContador(0);
    return;
  }
  // Destaques/Breaking news no topo (max 3)
  let breaking = lista.filter(item => {
    const title = item.querySelector("title")?.textContent || "";
    const desc = item.querySelector("description")?.textContent || "";
    return isBreakingNews(title, desc);
  }).slice(0,3);
  let restantes = lista.filter(item => !breaking.includes(item));
  let final = breaking.concat(restantes);
  final.forEach(item => {
    try {
      const title = item.querySelector("title").textContent;
      const link = item.querySelector("link").textContent;
      const description = item.querySelector("description")?.textContent || "";
      const pubDate = item.querySelector("pubDate")?.textContent || "";
      const breaking = isBreakingNews(title, description);
      const card = document.createElement("div");
      card.className = "card" + (breaking ? " breaking" : "");
      card.innerHTML = `
        ${breaking ? '<span class="breaking-label">DESTAQUE</span>' : ''}
        <h3><a href="${link}" target="_blank">${title}</a></h3>
        <small style="color:#666;">${pubDate ? ('🕒 ' + formatarDataAMPM(pubDate)) : ''}</small>
        <p>${description}</p>
      `;
      noticias.appendChild(card);
    } catch (e) {}
  });
  atualizarContador(final.length);
}

function carregarEditoriasNav() {
  const nav = document.getElementById('editorias');
  nav.innerHTML = '';
  feeds.forEach((feed, idx) => {
    const btn = document.createElement('button');
    btn.textContent = feed.nome;
    btn.onclick = () => selecionarEditoria(idx);
    btn.id = "btn-edit-" + idx;
    btn.style.display = 'none'; // só mostra na personalização
    nav.appendChild(btn);
  });
}

function exibirCustomEditoriasBar() {
  const bar = document.getElementById('custom-editorias-bar');
  bar.innerHTML = '';
  customEditorias.forEach(idx => {
    if (!feeds[idx]) return;
    const btn = document.createElement('button');
    btn.textContent = feeds[idx].nome;
    btn.onclick = () => selecionarEditoria(idx);
    btn.className = (editoriaAtual===idx ? "selected" : "");
    bar.appendChild(btn);

    const btnX = document.createElement('button');
    btnX.textContent = 'x';
    btnX.title = 'Remover editoria';
    btnX.className = "remove";
    btnX.onclick = (e) => {
      e.stopPropagation();
      removerEditoriaPersonalizada(idx);
    }
    bar.appendChild(btnX);
  });
}

function abrirConfigEditoria() {
  document.getElementById('config-editoria').style.display = 'block';
  document.getElementById('btn-personalizar').style.display = 'none';
  // Preencher select com feeds disponíveis não inclusos
  const sel = document.getElementById('select-editoria');
  sel.innerHTML = '';
  feeds.forEach((feed, idx) => {
    if (!customEditorias.includes(idx)) {
      const opt = document.createElement('option');
      opt.value = idx;
      opt.textContent = feed.nome;
      sel.appendChild(opt);
    }
  });
}

function fecharConfigEditoria() {
  document.getElementById('config-editoria').style.display = 'none';
  document.getElementById('btn-personalizar').style.display = 'block';
}

function adicionarEditoriaPersonalizada() {
  const sel = document.getElementById('select-editoria');
  const idx = parseInt(sel.value);
  if (!customEditorias.includes(idx)) {
    customEditorias.push(idx);
    salvarCustomEditorias();
    exibirCustomEditoriasBar();
    fecharConfigEditoria();
  }
}

function removerEditoriaPersonalizada(idx) {
  if (customEditorias.length <= 1) return; // sempre pelo menos 1 editoria
  customEditorias = customEditorias.filter(i => i!==idx);
  salvarCustomEditorias();
  if (!customEditorias.includes(editoriaAtual)) {
    selecionarEditoria(customEditorias[0]);
  } else {
    exibirCustomEditoriasBar();
  }
}

function selecionarEditoria(idx) {
  editoriaAtual = idx;
  exibirCustomEditoriasBar();
  carregarEditorias(idx);
}

function carregarEditorias(idx) {
  const rssUrl = feeds[idx].url;
  const noticias = document.getElementById("noticias");
  noticias.innerHTML = "<p>Carregando notícias...</p>";
  atualizarContador(0);

  fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(rssUrl)}`)
    .then(response => response.json())
    .then(data => {
      const parser = new DOMParser();
      const xml = parser.parseFromString(data.contents, "application/xml");
      noticiasAtuais = Array.from(xml.querySelectorAll("item"));
      aplicarFiltroData();
    })
    .catch(err => {
      noticias.innerHTML = `<p>Erro ao carregar notícias: ${err.message}</p>`;
    });
}

function buscarPorPalavra() {
  const termo = document.getElementById("termoBusca").value.trim();
  if (!termo) return;
  const rssBusca = `https://news.google.com/rss/search?q=${encodeURIComponent(termo)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`;
  const noticias = document.getElementById("noticias");
  noticias.innerHTML = "<p>Buscando notícias...</p>";
  atualizarContador(0);

  fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(rssBusca)}`)
    .then(response => response.json())
    .then(data => {
      const parser = new DOMParser();
      const xml = parser.parseFromString(data.contents, "application/xml");
      noticiasAtuais = Array.from(xml.querySelectorAll("item"));
      aplicarFiltroData();
    })
    .catch(err => {
      noticias.innerHTML = `<p>Erro ao buscar notícias: ${err.message}</p>`;
    });
}

// Filtro de data melhorado!
function aplicarFiltroData() {
  filtroDataAtual = document.getElementById('filtro-data').value;
  let agora = new Date();
  agora.setHours(0,0,0,0);
  let ontem = new Date(agora); ontem.setDate(agora.getDate()-1);
  let semana = new Date(agora); semana.setDate(agora.getDate()-7);
  let mes = new Date(agora); mes.setMonth(agora.getMonth()-1);

  noticiasFiltradas = noticiasAtuais.filter(item => {
    const pubDate = item.querySelector("pubDate")?.textContent;
    if (!pubDate) return false;
    const dataNoticia = new Date(pubDate);
    // Ajuste para timezone local: compara só o ano, mês e dia
    const localNoticia = new Date(dataNoticia.getFullYear(), dataNoticia.getMonth(), dataNoticia.getDate());
    switch(filtroDataAtual) {
      case 'hoje': return localNoticia.getTime() === agora.getTime();
      case 'ontem': return localNoticia.getTime() === ontem.getTime();
      case 'semana': return localNoticia >= semana;
      case 'mes': return localNoticia >= mes;
      default: return true;
    }
  });
  exibirNoticias(noticiasFiltradas);
}

// Inicialização
window.onload = () => {
  carregarCustomEditorias();
  carregarEditoriasNav();
  exibirCustomEditoriasBar();
  selecionarEditoria(customEditorias[0]);
};
</script>
</body>
</html>
