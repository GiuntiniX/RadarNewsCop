<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Radar de Not√≠cias ‚Äî Editorias & Subeditorias</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0f1112;
      --panel:#151718;
      --muted:#9aa3a8;
      --accent:#00aced;
      --accent-2:#00c853;
      --card:#ffffff;
      --card-text:#111;
      --gap:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
      background:var(--bg);
      color:#e8eef0;
    }

    header{
      background:linear-gradient(180deg,#141619 0%,#111214 100%);
      border-bottom:1px solid rgba(255,255,255,0.03);
      padding:14px 16px;
      position:sticky;
      top:0;
      z-index:50;
    }
    .header-inner{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:36px;height:36px}
    .brand .title{font-weight:700;font-size:1.1rem;color:var(--accent)}
    .meta{color:var(--muted);font-size:0.88rem}
    .meta a{color:var(--accent);text-decoration:underline}

    /* Main menu: only editorias in a single space */
    .menu-area{
      max-width:1200px;
      margin:12px auto 0;
      padding:12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
      background:linear-gradient(90deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.02);
    }
    .editoria-btn{
      padding:8px 12px;
      border-radius:10px;
      border:0;
      cursor:pointer;
      color:#fff;
      font-weight:700;
      background:linear-gradient(90deg,var(--accent),#48d6ff);
      box-shadow:0 6px 16px rgba(0,172,237,0.08);
      transition:transform .12s ease, box-shadow .12s ease, opacity .12s;
    }
    .editoria-btn.secondary{ background:linear-gradient(90deg,#607d8b,#b0bec5); color:#071018 }
    .editoria-btn.alt{ background:linear-gradient(90deg,#9c27b0,#d8a8e6); color:#14031b }
    .editoria-btn.small{ padding:6px 9px; font-weight:600; font-size:0.92rem }
    .editoria-btn[disabled]{ opacity:0.5; cursor:not-allowed; box-shadow:none }

    /* Subeditorias panel (quadrado abaixo do menu) */
    .sub-panel{
      max-width:1200px;
      margin:12px auto;
      padding:12px;
      background:var(--panel);
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.03);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-start;
      flex-wrap:wrap;
    }
    .sub-panel h4{margin:0 8px 0 0;color:var(--accent);font-size:0.95rem}
    .sub-btn{
      padding:8px 10px;
      border-radius:8px;
      border:0;
      cursor:pointer;
      color:#fff;
      background:rgba(255,255,255,0.03);
      font-weight:600;
      transition:background .12s;
    }
    .sub-btn.active{ background:linear-gradient(90deg,#47d2ff,#00aced); color:#071517; font-weight:800 }

    /* Actions (search + update) */
    .actions{
      max-width:1200px;
      margin:14px auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
    }
    .actions input{ padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;min-width:260px }
    .actions .btn{ padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#041114;font-weight:700; cursor:pointer }
    .timer{ color:var(--muted); font-size:0.92rem }

    /* Layout */
    .container{
      max-width:1200px;
      margin:20px auto 60px;
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:18px;
      align-items:start;
    }
    .main{ min-height:300px }

    /* Cards grid: 2 per line */
    .cards-grid{
      display:grid;
      grid-template-columns: repeat(2,1fr);
      gap:var(--gap);
    }
    .card{
      background:var(--card);
      color:var(--card-text);
      padding:12px 14px;
      border-radius:10px;
      box-shadow:0 6px 18px rgba(0,0,0,0.45);
      border-left:6px solid var(--accent);
      display:flex;
      flex-direction:column;
      min-height:130px;
    }
    .card h3{margin:0 0 6px;font-size:1rem}
    .card p{margin:0 0 8px;color:#333;flex:1;font-size:0.95rem}
    .card small{color:#666;display:block;margin-bottom:6px}
    .meta-row{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .source-pill{background:rgba(0,0,0,0.03);padding:6px 8px;border-radius:999px;font-size:0.85rem;color:#444}

    /* Sidebar */
    .sidebar{ position:relative }
    .sidebar h4{color:var(--accent); text-align:center; margin:0 0 8px}
    .sidebar .item{ background:var(--panel); border-radius:8px; padding:10px; margin-bottom:10px; color:var(--muted); border-left:4px solid rgba(255,255,255,0.03) }
    .sidebar .item a{ color:#9be9ff; text-decoration:underline; font-weight:600 }

    #contador-hoje{ color:var(--muted); text-align:center; margin-top:6px }

    @media (max-width:1000px){ .container{ grid-template-columns: 1fr 300px } }
    @media (max-width:820px){ .container{ grid-template-columns:1fr } .cards-grid{ grid-template-columns:1fr } .sidebar{order:2} }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="brand">
          <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f6f0.png" alt="Radar" />
          <div>
            <div class="title">Radar de Not√≠cias</div>
            <div class="meta" style="font-size:0.82rem">Desenvolvido por <a href="mailto:guilherme.giuntini@telefonica.com">Guilherme Giuntini</a></div>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <div class="timer" id="refresh-timer">‚è≥ Atualiza√ß√£o autom√°tica em --:--</div>
        <button class="btn" id="btn-refresh" onclick="refreshNoticias()">üîÑ Atualizar agora</button>
      </div>
    </div>

    <!-- MAIN EDITORIAS: single space only editorias (no subeditorias here) -->
    <div class="menu-area" id="menuArea" role="navigation" aria-label="Editorias principais"></div>

    <!-- SUBEDITORIAS panel (quadrado) -->
    <div class="sub-panel" id="subPanel" aria-live="polite" style="display:none">
      <h4 id="subPanelTitle">Subeditorias</h4>
      <div id="subButtons" style="display:flex;gap:8px;flex-wrap:wrap"></div>
    </div>

    <!-- Search / actions -->
    <div class="actions">
      <input id="termoBusca" type="text" placeholder="Buscar por palavra-chave (ex: elei√ß√µes, show, Copa do Mundo)" />
      <button class="btn" onclick="buscarPorPalavra()">Buscar</button>
    </div>

    <div style="max-width:1200px;margin:8px auto 0;text-align:center">
      <div id="contador-hoje">üî¢ Not√≠cias carregadas hoje: 0</div>
    </div>
  </header>

  <div class="container">
    <main class="main" id="noticias" aria-live="polite">
      <!-- cards-grid ser√° inserido aqui -->
    </main>

    <aside class="sidebar" aria-label="Mais publicadas">
      <h4>Mais publicadas (√∫ltimas 5h)</h4>
      <div id="mais-publicadas"></div>
    </aside>
  </div>

<script>
/*
  O que fiz:
  - Reestruturei o menu para conter apenas as editorias principais em um espa√ßo √∫nico.
  - Removi os itens que pediu (futebol, futebol feminino, fofoca, celebridade, A Fazenda,
    startups, G1, UOL, GloboEsporte) do menu principal.
  - Criei um painel de subeditorias (quadrado abaixo do menu). Ao clicar em uma editoria principal:
      - o painel abre mostrando as subeditorias correspondentes;
      - carrega as not√≠cias da editoria principal (hoje) imediatamente;
      - ao clicar numa subeditoria, carrega apenas a subeditoria.
  - Mantive o layout de cards (1 card = 1 mat√©ria) com grid 2 por linha.
  - Mantive atualiza√ß√£o autom√°tica e bot√£o manual.
  Pr√≥ximo passo: posso adicionar cache e lazy-loading para performance (j√° posso incluir se quiser).
*/

const MAIN_EDITORIAS = [
  'Geral','Brasil','Mundo','Pol√≠tica','Economia',
  'Ci√™ncia','Sa√∫de','Educa√ß√£o','Meio Ambiente',
  'Tecnologia','Neg√≥cios','Cultura','Entretenimento',
  'Arte','Moda','Culin√°ria','Turismo','Religi√£o',
  'Carreira','Opini√£o','Esportes'
];

// Mapping main editoria -> array of subeditorias { nome, url }
const SUBEDITORIAS = {
  'Geral': [
    { nome: 'Tudo (Google News *)', url: 'https://news.google.com/rss/search?q=*&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: '√öltimas', url: 'https://news.google.com/rss?hl=pt-BR&gl=BR&ceid=BR:pt-419' }
  ],
  'Brasil': [
    { nome: 'Brasil (GNews)', url: 'https://news.google.com/rss/headlines/section/geo/Brasil?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Pol√≠tica Regional', url: 'https://news.google.com/rss/search?q=governo+estadual&hl=pt-BR&gl=BR&ceid=BR:pt-419' }
  ],
  'Mundo': [
    { nome: 'Mundo (GNews)', url: 'https://news.google.com/rss/headlines/section/topic/WORLD.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Conflitos', url: 'https://news.google.com/rss/search?q=conflito&hl=pt-BR&gl=BR&ceid=BR:pt-419' }
  ],
  'Pol√≠tica': [
    { nome: 'Pol√≠tica (GNews)', url: 'https://news.google.com/rss/headlines/section/topic/POLITICS.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Elei√ß√µes', url: 'https://news.google.com/rss/search?q=elei√ß√µes&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Gabinete e Governo', url: 'https://news.google.com/rss/search?q=presidente+governo&hl=pt-BR&gl=BR&ceid=BR:pt-419' }
  ],
  'Economia': [
    { nome: 'Economia (GNews)', url: 'https://news.google.com/rss/headlines/section/topic/BUSINESS.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Mercado', url: 'https://news.google.com/rss/search?q=mercado+financeiro&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Empresas', url: 'https://news.google.com/rss/search?q=empresas&hl=pt-BR&gl=BR&ceid=BR:pt-419' }
  ],
  'Ci√™ncia': [
    { nome: 'Ci√™ncia (GNews)', url: 'https://news.google.com/rss/headlines/section/topic/SCIENCE.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Pesquisa', url: 'https://news.google.com/rss/search?q=pesquisa+cient√≠fica&hl=pt-BR&gl=BR&ceid=BR:pt-419' }
  ],
  'Sa√∫de': [
    { nome: 'Sa√∫de (GNews)', url: 'https://news.google.com/rss/headlines/section/topic/HEALTH.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Pandemia/Sa√∫de P√∫blica', url: 'https://news.google.com/rss/search?q=sa√∫de+p√∫blica&hl=pt-BR&gl=BR&ceid=BR:pt-419' }
  ],
  'Educa√ß√£o': [
    { nome: 'Educa√ß√£o (GNews)', url: 'https://news.google.com/rss/search?q=educa√ß√£o&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Universidades', url: 'https://news.google.com/rss/search?q=universidade&hl=pt-BR&gl=BR&ceid=BR:pt-419' }
  ],
  'Meio Ambiente': [
    { nome: 'Meio Ambiente', url: 'https://news.google.com/rss/search?q=meio+ambiente&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Clima', url: 'https://news.google.com/rss/search?q=clima&hl=pt-BR&gl=BR&ceid=BR:pt-419' }
  ],
  'Tecnologia': [
    { nome: 'Tecnologia (GNews)', url: 'https://news.google.com/rss/headlines/section/topic/TECHNOLOGY.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Startups', url: 'https://news.google.com/rss/search?q=startups&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Gadgets', url: 'https://news.google.com/rss/search?q=gadgets&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'IA / Machine Learning', url: 'https://news.google.com/rss/search?q=intelig√™ncia+artificial&hl=pt-BR&gl=BR&ceid=BR:pt-419' }
  ],
  'Neg√≥cios': [
    { nome: 'Neg√≥cios (GNews)', url: 'https://news.google.com/rss/headlines/section/topic/BUSINESS.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Finan√ßas Pessoais', url: 'https://news.google.com/rss/search?q=finan√ßas+pessoais&hl=pt-BR&gl=BR&ceid=BR:pt-419' }
  ],
  'Cultura': [
    { nome: 'Cultura', url: 'https://news.google.com/rss/search?q=cultura&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Literatura', url: 'https://news.google.com/rss/search?q=livros&hl=pt-BR&gl=BR&ceid=BR:pt-419' }
  ],
  'Entretenimento': [
    { nome: 'Entretenimento (GNews)', url: 'https://news.google.com/rss/headlines/section/topic/ENTERTAINMENT.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Celebridades', url: 'https://news.google.com/rss/search?q=celebridades&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Fofocas', url: 'https://news.google.com/rss/search?q=fofoca+celebridades&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Reality Shows', url: 'https://news.google.com/rss/search?q=reality+show&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'TV e S√©ries', url: 'https://news.google.com/rss/search?q=tv+s√©ries&hl=pt-BR&gl=BR&ceid=BR:pt-419' }
  ],
  'Arte': [
    { nome: 'Arte', url: 'https://news.google.com/rss/search?q=arte&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Exposi√ß√µes', url: 'https://news.google.com/rss/search?q=exposi√ß√£o&hl=pt-BR&gl=BR&ceid=BR:pt-419' }
  ],
  'Moda': [
    { nome: 'Moda', url: 'https://news.google.com/rss/search?q=moda&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Beleza', url: 'https://news.google.com/rss/search?q=beleza&hl=pt-BR&gl=BR&ceid=BR:pt-419' }
  ],
  'Culin√°ria': [
    { nome: 'Culin√°ria', url: 'https://news.google.com/rss/search?q=culin√°ria&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Receitas', url: 'https://news.google.com/rss/search?q=receitas&hl=pt-BR&gl=BR&ceid=BR:pt-419' }
  ],
  'Turismo': [
    { nome: 'Turismo', url: 'https://news.google.com/rss/search?q=turismo&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Destinos', url: 'https://news.google.com/rss/search?q=destino+tur√≠stico&hl=pt-BR&gl=BR&ceid=BR:pt-419' }
  ],
  'Religi√£o': [
    { nome: 'Religi√£o', url: 'https://news.google.com/rss/search?q=religi√£o&hl=pt-BR&gl=BR&ceid=BR:pt-419' }
  ],
  'Carreira': [
    { nome: 'Carreira', url: 'https://news.google.com/rss/search?q=carreira&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Emprego', url: 'https://news.google.com/rss/search?q=emprego&hl=pt-BR&gl=BR&ceid=BR:pt-419' }
  ],
  'Opini√£o': [
    { nome: 'Opini√£o (Colunas)', url: 'https://news.google.com/rss/search?q=opini√£o+coluna&hl=pt-BR&gl=BR&ceid=BR:pt-419' }
  ],
  'Esportes': [
    { nome: 'Esportes (GNews)', url: 'https://news.google.com/rss/headlines/section/topic/SPORTS.pt_br?hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Futebol Masculino', url: 'https://news.google.com/rss/search?q=futebol&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Futebol Feminino', url: 'https://news.google.com/rss/search?q=futebol+feminino&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'F1', url: 'https://news.google.com/rss/search?q=F1&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Basquete', url: 'https://news.google.com/rss/search?q=basquete&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'V√¥lei', url: 'https://news.google.com/rss/search?q=v√¥lei&hl=pt-BR&gl=BR&ceid=BR:pt-419' },
    { nome: 'Copa do Mundo', url: 'https://news.google.com/rss/search?q=copa+do+mundo&hl=pt-BR&gl=BR&ceid=BR:pt-419' }
  ]
};

// We'll fetch only when a main/sub is clicked (not preloading everything).
let editoriaSelecionada = null;
let subSelecionada = null;
let noticiasAtuais = [];
let isLoading = false;

/* Helpers */
function el(sel){ return document.querySelector(sel) }
function setLoading(on){
  isLoading = on;
  const buttons = document.querySelectorAll('.editoria-btn, .sub-btn');
  buttons.forEach(b => b.disabled = on);
}
function formatDate(pubStr){
  if(!pubStr) return '';
  const d = new Date(pubStr);
  if(isNaN(d)) return '';
  return d.toLocaleString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false }).replace(',', ' -');
}
function isDateToday(pubStr){
  if(!pubStr) return false;
  const d = new Date(pubStr);
  if(isNaN(d)) return false;
  const now = new Date();
  return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth() && d.getDate() === now.getDate();
}

/* Fetch RSS via CORS proxy (allorigins) */
async function fetchRss(url){
  try{
    const resp = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
    if(!resp.ok) throw new Error('proxy-fail');
    const data = await resp.json();
    const parser = new DOMParser();
    const xml = parser.parseFromString(data.contents, 'application/xml');
    const items = Array.from(xml.querySelectorAll('item'));
    return items;
  } catch(e){
    console.warn('Erro ao buscar feed', url, e);
    return [];
  }
}

/* Render main menu (only editorias) */
function renderMainMenu(){
  const menu = document.getElementById('menuArea');
  menu.innerHTML = '';
  MAIN_EDITORIAS.forEach(name => {
    const btn = document.createElement('button');
    btn.className = 'editoria-btn';
    btn.textContent = name;
    btn.onclick = () => onMainClick(name);
    menu.appendChild(btn);
  });
}

/* Render subeditorias panel for a main editoria */
function renderSubPanel(main){
  const panel = document.getElementById('subPanel');
  const subButtons = document.getElementById('subButtons');
  const title = document.getElementById('subPanelTitle');
  const subs = SUBEDITORIAS[main] || [];
  if(subs.length === 0){
    panel.style.display = 'none';
    subButtons.innerHTML = '';
    title.textContent = '';
    return;
  }
  panel.style.display = 'flex';
  title.textContent = `${main} ‚Äî Subeditorias`;
  subButtons.innerHTML = '';
  // add a "Ver tudo (principal)" button first
  const allBtn = document.createElement('button');
  allBtn.className = 'sub-btn';
  allBtn.textContent = `Ver todas (${main})`;
  allBtn.onclick = () => loadFeedFor(main, subs[0].url, null); // load main via first sub (or main's primary)
  subButtons.appendChild(allBtn);

  subs.forEach(s => {
    const b = document.createElement('button');
    b.className = 'sub-btn';
    b.textContent = s.nome;
    b.onclick = () => loadFeedFor(main, s.url, s.nome);
    subButtons.appendChild(b);
  });
}

/* UI helpers to mark selected menu/sub */
function markSelected(main, subName){
  editoriaSelecionada = main;
  subSelecionada = subName;
  // main highlight
  const mainBtns = document.querySelectorAll('.menu-area .editoria-btn');
  mainBtns.forEach(btn => {
    btn.style.boxShadow = (btn.textContent === main) ? '0 8px 28px rgba(0,172,237,0.16)' : '0 6px 16px rgba(0,172,237,0.08)';
  });
  // sub highlight
  const subBtns = document.querySelectorAll('.sub-btn');
  subBtns.forEach(sb => {
    if(subName && sb.textContent === subName) sb.classList.add('active'); else sb.classList.remove('active');
  });
}

/* Render cards (2 per row) ‚Äî cada mat√©ria em um card */
function renderCards(items){
  const mainEl = document.getElementById('noticias');
  mainEl.innerHTML = '';
  const grid = document.createElement('div');
  grid.className = 'cards-grid';
  let count = 0;
  items.forEach(it => {
    try{
      const title = it.querySelector('title')?.textContent || '(sem t√≠tulo)';
      const link = it.querySelector('link')?.textContent || '#';
      const desc = it.querySelector('description')?.textContent || '';
      const pub = it.querySelector('pubDate')?.textContent || '';
      const host = (()=>{ try { return new URL(link).hostname.replace('www.',''); } catch(e){ return ''; } })();
      const card = document.createElement('article');
      card.className = 'card';
      card.innerHTML = `
        <h3><a href="${link}" target="_blank" rel="noopener noreferrer">${title}</a></h3>
        <small>üïí ${pub ? formatDate(pub) : ''}</small>
        <p>${desc}</p>
        <div class="meta-row">
          <div class="source-pill">${host}</div>
          <div style="font-size:0.84rem;color:#888"></div>
        </div>`;
      grid.appendChild(card);
      count++;
    }catch(e){}
  });
  mainEl.appendChild(grid);
  document.getElementById('contador-hoje').textContent = `üî¢ Not√≠cias carregadas hoje: ${count}`;
}

/* Sidebar: mais publicadas nas √∫ltimas 5 horas (agrupa t√≠tulos similares) */
function updateSidebarFrom(items){
  const container = document.getElementById('mais-publicadas');
  container.innerHTML = '';
  if(!items || items.length === 0){
    container.innerHTML = `<div style="color:var(--muted)">Sem dados recentes.</div>`;
    return;
  }
  const now = new Date();
  const cincoHoras = new Date(now.getTime() - 5*60*60*1000);
  const map = {};
  items.forEach(it => {
    try{
      const pub = new Date(it.querySelector('pubDate')?.textContent || 0);
      if(isNaN(pub) || pub < cincoHoras) return;
      const title = (it.querySelector('title')?.textContent || '').trim();
      if(!title) return;
      const key = title.toLowerCase().replace(/[^\w\s]/g,'').substring(0,200);
      if(!map[key]) map[key] = { count:0, item: it, latest: pub };
      map[key].count++;
      if(pub > map[key].latest) map[key].latest = pub;
    }catch(e){}
  });
  const list = Object.values(map).sort((a,b)=> b.count - a.count || b.latest - a.latest).slice(0,12);
  if(list.length === 0){
    container.innerHTML = `<div style="color:var(--muted)">Sem publica√ß√µes nas √∫ltimas 5 horas.</div>`;
    return;
  }
  list.forEach(entry => {
    const it = entry.item;
    const title = it.querySelector('title')?.textContent || '(sem t√≠tulo)';
    const link = it.querySelector('link')?.textContent || '#';
    const pub = it.querySelector('pubDate')?.textContent || '';
    const host = (()=>{ try { return new URL(link).hostname.replace('www.',''); } catch(e){ return ''; } })();
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `<a href="${link}" target="_blank" rel="noopener noreferrer">${title}</a>
      <div style="margin-top:6px;color:var(--muted);font-size:0.88rem">üóû ${host} ‚Ä¢ ${formatDate(pub)} ${entry.count>1?` ‚Ä¢ √ó${entry.count}`:''}</div>`;
    container.appendChild(div);
  });
}

/* Primary loader for a given feed URL (filters only items from today) */
async function loadFeedFor(mainName, feedUrl, subName){
  // Show selection and prevent concurrent clicks
  markSelected(mainName, subName || null);
  setLoading(true);
  document.getElementById('noticias').innerHTML = `<div style="color:var(--muted);padding:12px;border-radius:8px">Carregando ${subName?subName:mainName} (apenas HOJE)...</div>`;
  // fetch feed
  let items = await fetchRss(feedUrl);
  // filter items to "today"
  items = items.filter(it => isDateToday(it.querySelector('pubDate')?.textContent));
  // sort desc by pubDate
  items.sort((a,b) => new Date(b.querySelector('pubDate')?.textContent||0) - new Date(a.querySelector('pubDate')?.textContent||0));
  noticiasAtuais = items;
  if(items.length === 0){
    // fallback: attempt GoogleNews * search for today's items
    const fallback = await fetchRss('https://news.google.com/rss/search?q=*&hl=pt-BR&gl=BR&ceid=BR:pt-419');
    const fbToday = fallback.filter(it => isDateToday(it.querySelector('pubDate')?.textContent));
    if(fbToday.length){
      noticiasAtuais = fbToday.sort((a,b)=> new Date(b.querySelector('pubDate')?.textContent||0) - new Date(a.querySelector('pubDate')?.textContent||0));
      renderCards(noticiasAtuais);
      updateSidebarFrom(noticiasAtuais);
      setLoading(false);
      return;
    }
    document.getElementById('noticias').innerHTML = `<div style="color:var(--muted);padding:12px;border-radius:8px">Nenhuma not√≠cia encontrada para HOJE em <b>${subName?subName:mainName}</b>.</div>`;
    document.getElementById('contador-hoje').textContent = `üî¢ Not√≠cias carregadas hoje: 0`;
    updateSidebarFrom([]);
    setLoading(false);
    return;
  }
  renderCards(noticiasAtuais);
  updateSidebarFrom(noticiasAtuais);
  setLoading(false);
}

/* Handler: main clicked -> show subs + load main feed (use first sub feed as main if available) */
function onMainClick(mainName){
  // render subs
  renderSubPanel(mainName);
  // load primary feed for the main (choose the first subeditoria url if present)
  const subs = SUBEDITORIAS[mainName] || [];
  const feedUrl = subs.length ? subs[0].url : 'https://news.google.com/rss?hl=pt-BR&gl=BR&ceid=BR:pt-419';
  loadFeedFor(mainName, feedUrl, null);
}

/* Search by keyword (Google News search, filter today) */
async function buscarPorPalavra(){
  const termo = document.getElementById('termoBusca').value.trim();
  if(!termo) {
    // if empty, reload current selection
    if(editoriaSelecionada){
      // reload selection
      const subs = SUBEDITORIAS[editoriaSelecionada] || [];
      const feedUrl = subs.length ? subs[0].url : 'https://news.google.com/rss?hl=pt-BR&gl=BR&ceid=BR:pt-419';
      loadFeedFor(editoriaSelecionada, feedUrl, subSelecionada);
    } else {
      // default: load "Tudo"
      loadFeedFor('Geral','https://news.google.com/rss/search?q=*&hl=pt-BR&gl=BR&ceid=BR:pt-419', null);
    }
    return;
  }
  setLoading(true);
  document.getElementById('noticias').innerHTML = `<div style="color:var(--muted);padding:12px;border-radius:8px">Buscando "${termo}" em not√≠cias de hoje...</div>`;
  const rssBusca = `https://news.google.com/rss/search?q=${encodeURIComponent(termo)}&hl=pt-BR&gl=BR&ceid=BR:pt-419`;
  const items = await fetchRss(rssBusca);
  const filtradas = items.filter(it => isDateToday(it.querySelector('pubDate')?.textContent));
  filtradas.sort((a,b)=> new Date(b.querySelector('pubDate')?.textContent||0) - new Date(a.querySelector('pubDate')?.textContent||0));
  noticiasAtuais = filtradas;
  if(filtradas.length === 0){
    document.getElementById('noticias').innerHTML = `<div style="color:var(--muted);padding:12px;border-radius:8px">Nenhuma not√≠cia de HOJE encontrada para "${termo}".</div>`;
    document.getElementById('contador-hoje').textContent = `üî¢ Not√≠cias carregadas hoje: 0`;
    updateSidebarFrom([]);
    setLoading(false);
    return;
  }
  renderCards(noticiasAtuais);
  updateSidebarFrom(noticiasAtuais);
  setLoading(false);
}

/* Auto refresh logic (15 min) + manual refresh */
let refreshInterval = 15 * 60;
let refreshCountdown = refreshInterval;
let refreshTimerId = null;
function atualizarTimer(){
  const el = document.getElementById('refresh-timer');
  if(!el) return;
  const m = String(Math.floor(refreshCountdown/60)).padStart(2,'0');
  const s = String(refreshCountdown%60).padStart(2,'0');
  el.textContent = `‚è≥ Atualiza√ß√£o autom√°tica em ${m}:${s}`;
}
function iniciarAutoRefresh(){
  if(refreshTimerId) clearInterval(refreshTimerId);
  refreshCountdown = refreshInterval;
  atualizarTimer();
  refreshTimerId = setInterval(()=>{
    refreshCountdown--;
    if(refreshCountdown <= 0){
      refreshCountdown = refreshInterval;
      // refresh current selection
      if(editoriaSelecionada){
        const subs = SUBEDITORIAS[editoriaSelecionada] || [];
        const feedUrl = subSelecionada ? (subs.find(s=>s.nome===subSelecionada)?.url || subs[0]?.url) : (subs[0]?.url || 'https://news.google.com/rss?hl=pt-BR&gl=BR&ceid=BR:pt-419');
        loadFeedFor(editoriaSelecionada, feedUrl, subSelecionada);
      } else {
        loadFeedFor('Geral','https://news.google.com/rss/search?q=*&hl=pt-BR&gl=BR&ceid=BR:pt-419', null);
      }
    }
    atualizarTimer();
  },1000);
}
function refreshNoticias(){
  if(editoriaSelecionada){
    const subs = SUBEDITORIAS[editoriaSelecionada] || [];
    const feedUrl = subSelecionada ? (subs.find(s=>s.nome===subSelecionada)?.url || subs[0]?.url) : (subs[0]?.url || 'https://news.google.com/rss?hl=pt-BR&gl=BR&ceid=BR:pt-419');
    loadFeedFor(editoriaSelecionada, feedUrl, subSelecionada);
  } else {
    loadFeedFor('Geral','https://news.google.com/rss/search?q=*&hl=pt-BR&gl=BR&ceid=BR:pt-419', null);
  }
  refreshCountdown = refreshInterval;
  atualizarTimer();
}

/* Init */
function init(){
  renderMainMenu();
  // default select "Geral"
  onMainClick('Geral');
  iniciarAutoRefresh();
}
init();
</script>
</body>
</html>
